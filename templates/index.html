<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è‚¡ç¥¨å¯¹æ¯”å±•ç¤º</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body, input, button, select, label {
            font-family: 'Lato', Arial, sans-serif;
        }
        body { margin: 40px; }
        #chart-container { width: 90vw; max-width: 1200px; margin: auto; }
    </style>
</head>
<body>
    <div id="baseDateDiv" style="position:absolute;top:24px;right:5vw;z-index:10;background:rgba(255,255,255,0.85);padding:4px 10px 10px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-family:'Lato',Arial,sans-serif;font-size:12px;min-width:220px;">
        <label style="font-family:'Lato',Arial,sans-serif;font-size:12px;">å¼€èµ›æ—¥æœŸ: <input type="date" id="baseDateInput" value="2025-10-20" style="font-family:'Lato',Arial,sans-serif;font-size:12px;"> </label>
        <button id="baseDateBtn" style="font-family:'Lato',Arial,sans-serif;font-size:12px;">åº”ç”¨</button>
        <div id="customStockArea" style="margin-top:8px;">
            <div style="margin-bottom:2px;font-weight:bold;">è‡ªå®šä¹‰è‚¡ç¥¨(æœ€å¤š5ä¸ª):</div>
            <div id="customStockList"></div>
            <div style="margin-top:4px;">
                <input id="customStockInput" type="text" maxlength="12" placeholder="è‚¡ç¥¨ä»£ç " style="width:80px;font-size:12px;">
                <button id="addCustomStockBtn" style="font-size:12px;">æ·»åŠ </button>
            </div>
        </div>
    </div>
    <div id="chart-container">
        <canvas id="lineChart"></canvas>
    </div>
    <script src="/static/custom_code_loader.js"></script>
    <script src="/static/custom_code_save.js"></script>
    <script>
    // å®šä¹‰å¢å¤§åçš„ç‚¹åŠå¾„
    const VISIBLE_POINT_RADIUS = 6;
    const HOVER_POINT_RADIUS = 12;
    
    // æ³¨å†Œ annotation 3.x æ’ä»¶åˆ° Chart.js 3.x
    if (window.Chart && window.ChartAnnotation) {
        Chart.register(window.ChartAnnotation);
    }


    async function fetchData(baseDateStr, customStocks) {
        // æ”¯æŒä¼ é€’åŸºå‡†æ—¥æœŸå‚æ•°å’Œè‡ªå®šä¹‰è‚¡ç¥¨
        let url = '/api/lines';
        let params = [];
        if (baseDateStr) params.push('base_date=' + encodeURIComponent(baseDateStr));
        if (customStocks && customStocks.length) params.push('codes=' + encodeURIComponent(customStocks.join(',')));
        if (params.length) url += '?' + params.join('&');
        const resp = await fetch(url);
        return await resp.json();
    }

    /**
     * æ ¹æ® priceX æ•°æ®è®¡ç®—æ¯ä¸ªç‚¹çš„åŠå¾„ã€‚
     */
    function getCommentRadii(prices) {
        if (!prices || prices.length === 0) return [];
        return prices.map((p) => (p && typeof p === 'object' && p.comment && p.comment.trim() !== '') ? VISIBLE_POINT_RADIUS : 0);
    }


    // ä½¿ç”¨ Lato ä½œä¸º Chart.js çš„å…¨å±€é»˜è®¤å­—ä½“ï¼ˆ3.x åªæ”¯æŒå…¨å±€è®¾ç½®ï¼‰
    if (window.Chart && Chart.defaults) {
        Chart.defaults.font.family = 'Lato, Arial, sans-serif';
    }

    function formatLabelTimestr(s) {
        // è¾“å…¥ç±»ä¼¼ '2025-09-26 10:30:00'ï¼Œè¾“å‡º 'Sep 26 10:30' å½¢å¼
        const d = new Date(s);
        if (isNaN(d.getTime())) return s;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const mon = months[d.getMonth()];
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${mon} ${dd} ${hh}:${min}`;
    }

    let chartInstance = window._chartInstance;
    // è·å–å½“å‰åŸºå‡†æ—¥æœŸï¼ˆyyyy-mm-ddï¼‰ï¼Œæ— åˆ™è¿”å›ç©ºä¸²
    function getCurrentBaseDate() {
        const input = document.getElementById('baseDateInput');
        // ç¡®ä¿å…ƒç´ å­˜åœ¨ä¸”æœ‰å€¼
        return input && input.value ? input.value : '';
    }

    function renderChart(data) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        // é”€æ¯æ—§å®ä¾‹ï¼Œé˜²æ­¢å¤šæ¬¡æ¸²æŸ“å åŠ 
        if (window._chartInstance) {
            window._chartInstance.destroy();
        }
        // æ ¼å¼åŒ– x è½´æ ‡ç­¾
        const formattedLabels = (data.labels || []).map(formatLabelTimestr);
        // çº¿çš„åå­—å’Œä»£ç æ˜ å°„
        const meta = data.lineMeta || [
            {name: 'æ²ªæ·±300', code: '000300.XSHG'},
            {name: 'ç§‘åˆ›50', code: '000688.XSHG'},
            {name: 'Deepseek', code: 'Deepseek'}
        ];
        
        // è®¡ç®—ç‚¹è¯„åŠå¾„
        const radii1 = getCommentRadii(data.price1);
        const radii2 = getCommentRadii(data.price2);
        const radii3 = getCommentRadii(data.price3);

        // æŸ¥æ‰¾åŸºå‡†æ—¥æœŸåœ¨labelsä¸­çš„ç´¢å¼•
        const baseDate = getCurrentBaseDate();
        let baseIdx = -1;
        
        // ** ã€å…³é”®æ£€æŸ¥ç‚¹ã€‘ **
        // ç¡®ä¿ baseDate æœ‰å€¼ï¼Œä¸”èƒ½åœ¨ labels ä¸­æ‰¾åˆ°å¯¹åº”æ—¥æœŸ
        if (baseDate && data.labels && data.labels.length) {
            // æŸ¥æ‰¾æ ‡ç­¾ä¸­æ—¥æœŸéƒ¨åˆ†ä¸è¾“å…¥æ—¥æœŸåŒ¹é…çš„ç¬¬ä¸€ä¸ªç´¢å¼•
            baseIdx = data.labels.findIndex(lab => String(lab).slice(0,10) === baseDate);
        }

        // ==========================================================
        // ** ä¿®å¤é€»è¾‘ï¼šæ„é€ å®Œæ•´çš„ datasets æ•°ç»„ **
        // ==========================================================
        let datasets = [
            {
                label: meta[0].name,
                data: data.line1,
                borderColor: 'rgba(54,162,235,1)',
                backgroundColor: 'rgba(54,162,235,0.1)',
                fill: false,
                pointRadius: radii1,
                pointHoverRadius: radii1.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii1.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii1.map(r => r > 0 ? 'white' : 'rgba(54,162,235,1)'),
                pointHoverBackgroundColor: radii1.map(r => r > 0 ? 'rgba(54,162,235,1)' : 'rgba(54,162,235,1)'),
                customPrices: data.price1,
                code: meta[0].code
            },
            {
                label: meta[1].name,
                data: data.line2,
                borderColor: 'rgba(75,192,192,1)',
                backgroundColor: 'rgba(75,192,192,0.1)',
                fill: false,
                pointRadius: radii2,
                pointHoverRadius: radii2.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii2.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii2.map(r => r > 0 ? 'white' : 'rgba(75,192,192,1)'),
                pointHoverBackgroundColor: radii2.map(r => r > 0 ? 'rgba(75,192,192,1)' : 'rgba(75,192,192,1)'),
                customPrices: data.price2,
                code: meta[1].code
            },
            {
                label: meta[2].name,
                data: data.line3,
                borderColor: 'rgba(255,99,132,1)',
                backgroundColor: 'rgba(255,99,132,0.1)',
                fill: false,
                pointRadius: radii3,
                pointHoverRadius: radii3.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii3.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii3.map(r => r > 0 ? 'white' : 'rgba(255,99,132,1)'),
                pointHoverBackgroundColor: radii3.map(r => r > 0 ? 'rgba(255,99,132,1)' : 'rgba(255,99,132,1)'),
                pointBorderColor: 'rgba(255,99,132,1)',
                pointBorderWidth: 2,
                customPrices: data.price3,
                code: meta[2].code
            }
        ];

        // åŠ¨æ€æ·»åŠ è‡ªå®šä¹‰è‚¡ç¥¨æ•°æ®
        if (data.customLines && Array.isArray(data.customLines) && data.customPrices && Array.isArray(data.customPrices)) {
            const colors = [
                'rgba(255,159,64,1)',  // æ©™è‰²
                'rgba(153,102,255,1)', // ç´«è‰²
                'rgba(255,205,86,1)',  // é»„è‰²
                'rgba(201,203,207,1)', // ç°è‰²
                'rgba(0,128,128,1)'    // é’è‰²
            ];
            
            const customDatasets = data.customLines.map((line, index) => {
                const customPrices = data.customPrices[index];
                // ä½¿ç”¨ customStocks å˜é‡è·å–ä»£ç åç§°
                const customCode = customStocks[index] || `è‡ªå®šä¹‰${index + 1}`; 
                const customMeta = meta[3 + index] || { name: customCode, code: customCode };
                
                const radii = getCommentRadii(customPrices);
                const colorIndex = index % colors.length; 
                const borderColor = colors[colorIndex];
                const backgroundColor = borderColor.replace('1)', '0.1)'); // ç”¨äºèƒŒæ™¯å¡«å……

                return {
                    label: customMeta.name,
                    data: line,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    fill: false,
                    pointRadius: radii,
                    pointHoverRadius: radii.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                    pointStyle: radii.map(r => r > 0 ? 'circle' : 'circle'),
                    pointBackgroundColor: radii.map(r => r > 0 ? 'white' : borderColor),
                    pointHoverBackgroundColor: radii.map(r => r > 0 ? borderColor : borderColor),
                    customPrices: customPrices,
                    code: customMeta.code
                };
            });
            datasets = datasets.concat(customDatasets); // æ‹¼æ¥æ•°ç»„
        }

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                // ** ä½¿ç”¨å®Œæ•´çš„ datasets å˜é‡ **
                datasets: datasets 
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'nearest',
                    intersect: true
                },
                hover: {
                    mode: 'nearest',
                    intersect: true,
                    animationDuration: 0
                },
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 16 } } },
                    tooltip: {
                        mode: 'nearest',
                        intersect: true,
                        callbacks: {
                            label: function(context) {
                                const ds = context.dataset;
                                const idx = context.dataIndex;
                                const label = ds.label || '';
                                const val = context.parsed.y;
                                const price = ds.customPrices ? ds.customPrices[idx] : undefined;
                                const radii = ds.pointRadius || [];
                                // åªåœ¨æœ‰ç‚¹è¯„èŠ‚ç‚¹æ—¶æ˜¾ç¤ºtooltip
                                if (Array.isArray(radii) && radii[idx] === 0) return '';
                                
                                // Deepseekï¼ˆå¸‚å€¼çº¿ï¼‰è¯¦ç»†tooltip
                                if (label === 'Deepseek' && price && typeof price === 'object') {
                                    const lines = [];
                                    lines.push(`Deepseek (å½’ä¸€åŒ–): ${val.toFixed(2)}`);
                                    lines.push(`æ€»ä»·å€¼ (RMB): ${price.total ? price.total.toFixed(2) : 'N/A'}`);
                                    lines.push(`ç°é‡‘ (RMB): ${price.cash ? price.cash.toFixed(2) : 'N/A'}`);
                                    const stocks = price.stocks || {};
                                    for (const code in stocks) {
                                        if (stocks.hasOwnProperty(code)) {
                                            const stock = stocks[code];
                                            lines.push(
                                                `  ${code}: è‚¡æ•° ${stock.shares}, ä»·æ ¼ ${stock.price ? stock.price.toFixed(2) : 'N/A'}, å¸‚å€¼ ${stock.value ? stock.value.toFixed(2) : 'N/A'}`
                                            );
                                        }
                                    }
                                    if (typeof price.comment === 'string' && price.comment.trim() !== '') {
                                        lines.push('å¤‡æ³¨: ' + price.comment);
                                    }
                                    return lines;
                                }
                                
                                // å…¶ä»–çº¿ï¼šå¦‚æœ‰ç‚¹è¯„ï¼Œä¼˜å…ˆå±•ç¤ºç‚¹è¯„ï¼Œå¦åˆ™å±•ç¤ºæ•°å€¼
                                if (price && typeof price === 'object' && price.comment && price.comment.trim() !== '') {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    return [`${label}: ${val.toFixed(2)} (åŸå§‹ä»·æ ¼: ${originalPrice.toFixed(2)})`, 'ç‚¹è¯„: ' + price.comment];
                                } else if (price !== undefined) {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    return `${label}: ${val.toFixed(2)} (åŸå§‹ä»·æ ¼: ${originalPrice.toFixed(2)})`;
                                } else {
                                    return `${label}: ${val.toFixed(2)}`;
                                }
                            },
                            title: function(context) {
                                if (context && context.length > 0) {
                                    const ds = context[0].dataset;
                                    const idx = context[0].dataIndex;
                                    const radii = ds.pointRadius || [];
                                    if (Array.isArray(radii) && radii[idx] === 0) return '';
                                }
                                return context[0].label;
                            }
                        }
                    },
                    annotation: {
                        // ** ã€ä¿®å¤ 2ï¼šé€»è¾‘æ£€æŸ¥ã€‘ **
                        // åªæœ‰å½“ baseIdx >= 0 (å³æ‰¾åˆ°åŒ¹é…æ—¥æœŸ) æ—¶ï¼Œæ‰ä¼šç”Ÿæˆ annotations å¯¹è±¡
                        annotations: baseIdx >= 0 ? {
                                baseLine: {
                                    type: 'line',
                                    xMin: baseIdx,
                                    xMax: baseIdx,
                                    borderColor: 'rgba(255, 140, 0, 0.3)',
                                    borderWidth: 4,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: 'åŸºå‡†',
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 140, 0, 0.85)',
                                        color: 'white',
                                        font: { weight: 'bold' }
                                    }
                                }
                        } : {} // å¦‚æœæœªæ‰¾åˆ°ï¼Œè¿”å›ç©ºå¯¹è±¡ï¼Œä¸ç»˜åˆ¶
                    }
                },
                scales: { x: { display: true }, y: { display: true } }
            }
        });

        // ä¿å­˜å®ä¾‹ï¼Œä¾¿äºä¸‹æ¬¡é”€æ¯
        window._chartInstance = chart;
    }
    
    // ===== è‡ªå®šä¹‰è‚¡ç¥¨ç®¡ç† =====
    let customStocks = [];
    function renderCustomStockList() {
        const listDiv = document.getElementById('customStockList');
        listDiv.innerHTML = '';
        customStocks.forEach((code, idx) => {
            const span = document.createElement('span');
            span.textContent = code;
            span.style.cssText = 'display:inline-block;background:#f2f2f2;border-radius:3px;padding:1px 6px;margin:0 4px 2px 0;';
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Ã—';
            delBtn.title = 'åˆ é™¤';
            delBtn.style.cssText = 'margin-left:2px;font-size:12px;color:#c00;background:none;border:none;cursor:pointer;';
            delBtn.onclick = function() {
            customStocks.splice(idx,1);
            renderCustomStockList();
            triggerChartUpdate();
            if (window.saveCustomCodes) window.saveCustomCodes();
        };
            span.appendChild(delBtn);
            listDiv.appendChild(span);
        });
    }
    document.getElementById('addCustomStockBtn').onclick = function() {
        const input = document.getElementById('customStockInput');
        let code = input.value.trim();
        if (!code) return;
        if (customStocks.length >= 5) { alert('æœ€å¤šæ·»åŠ 5ä¸ªè‡ªå®šä¹‰è‚¡ç¥¨'); return; }
        // è‡ªåŠ¨è¡¥å…¨åç¼€
        let codeNorm = code;
        if (!/\.X[SA]HG$|\.KH$|\.XSHE$/i.test(code)) {
            // åªè¾“å…¥æ•°å­—æ—¶è‡ªåŠ¨å°è¯•ä¸»æ¿ã€ç§‘åˆ›æ¿
            if (/^\d{6}$/.test(code)) {
                const trySuffix = ['.XSHG', '.XSHE', '.XHSG', '.KH'];
                for (let suf of trySuffix) {
                    if (!customStocks.includes(code + suf)) {
                        codeNorm = code + suf;
                        break;
                    }
                }
            }
        }
        if (customStocks.includes(codeNorm)) { alert('å·²å­˜åœ¨'); return; }
        customStocks.push(codeNorm);
        input.value = '';
        renderCustomStockList();
        triggerChartUpdate();
        // ğŸš¨ ä¿®å¤ï¼šæ·»åŠ æˆåŠŸåä¹Ÿéœ€è¦ä¿å­˜åˆ°åç«¯
        if (window.saveCustomCodes) window.saveCustomCodes(); 
    };
    function triggerChartUpdate() {
        const val = document.getElementById('baseDateInput').value;
        fetchData(val, customStocks).then(renderChart);
    }
    // ===== åŸºå‡†æ—¥æœŸé€‰æ‹©æ§ä»¶äº‹ä»¶ç»‘å®š =====
    document.getElementById('baseDateBtn').onclick = function() {
        triggerChartUpdate();
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”¨é»˜è®¤åŸºå‡†æ—¥æœŸæ¸²æŸ“
    const defaultBaseDate = document.getElementById('baseDateInput').value;
    fetchData(defaultBaseDate, customStocks).then(renderChart);
</script>
</body>
</html>