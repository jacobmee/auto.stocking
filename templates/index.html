<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>股票对比展示</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body, input, button, select, label {
            font-family: 'Lato', Arial, sans-serif;
        }
        body { margin: 40px; }
        #chart-container { width: 90vw; max-width: 1200px; margin: auto; }
    </style>
</head>
<body>
    <div id="baseDateDiv" style="position:absolute;top:24px;right:5vw;z-index:10;background:rgba(255,255,255,0.85);padding:4px 10px 10px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-family:'Lato',Arial,sans-serif;font-size:12px;min-width:220px;">
        <label style="font-family:'Lato',Arial,sans-serif;font-size:12px;">开赛日期: <input type="date" id="baseDateInput" value="2025-10-20" style="font-family:'Lato',Arial,sans-serif;font-size:12px;"> </label>
        <button id="baseDateBtn" style="font-family:'Lato',Arial,sans-serif;font-size:12px;">应用</button>
        <div id="customStockArea" style="margin-top:8px;">
            <div style="margin-bottom:2px;font-weight:bold;">自定义股票(最多5个):</div>
            <div id="customStockList"></div>
            <div style="margin-top:4px;">
                <input id="customStockInput" type="text" maxlength="12" placeholder="股票代码" style="width:80px;font-size:12px;">
                <button id="addCustomStockBtn" style="font-size:12px;">添加</button>
            </div>
        </div>
    </div>
    <div id="chart-container">
        <canvas id="lineChart"></canvas>
    </div>
    <script src="/static/custom_code_loader.js"></script>
    <script src="/static/custom_code_save.js"></script>
    <script>
    // 定义增大后的点半径
    const VISIBLE_POINT_RADIUS = 6;
    const HOVER_POINT_RADIUS = 12;
    
    // 注册 annotation 3.x 插件到 Chart.js 3.x
    if (window.Chart && window.ChartAnnotation) {
        Chart.register(window.ChartAnnotation);
    }


    async function fetchData(baseDateStr, customStocks) {
        // 支持传递基准日期参数和自定义股票
        let url = '/api/lines';
        let params = [];
        if (baseDateStr) params.push('base_date=' + encodeURIComponent(baseDateStr));
        if (customStocks && customStocks.length) params.push('codes=' + encodeURIComponent(customStocks.join(',')));
        if (params.length) url += '?' + params.join('&');
        const resp = await fetch(url);
        return await resp.json();
    }

    /**
     * 根据 priceX 数据计算每个点的半径。
     */
    function getCommentRadii(prices) {
        if (!prices || prices.length === 0) return [];
        return prices.map((p) => (p && typeof p === 'object' && p.comment && p.comment.trim() !== '') ? VISIBLE_POINT_RADIUS : 0);
    }


    // 使用 Lato 作为 Chart.js 的全局默认字体（3.x 只支持全局设置）
    if (window.Chart && Chart.defaults) {
        Chart.defaults.font.family = 'Lato, Arial, sans-serif';
    }

    function formatLabelTimestr(s) {
        // 输入类似 '2025-09-26 10:30:00'，输出 'Sep 26 10:30' 形式
        const d = new Date(s);
        if (isNaN(d.getTime())) return s;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const mon = months[d.getMonth()];
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${mon} ${dd} ${hh}:${min}`;
    }

    let chartInstance = window._chartInstance;
    // 获取当前基准日期（yyyy-mm-dd），无则返回空串
    function getCurrentBaseDate() {
        const input = document.getElementById('baseDateInput');
        // 确保元素存在且有值
        return input && input.value ? input.value : '';
    }

    function renderChart(data) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        // 销毁旧实例，防止多次渲染叠加
        if (window._chartInstance) {
            window._chartInstance.destroy();
        }
        // 格式化 x 轴标签
        const formattedLabels = (data.labels || []).map(formatLabelTimestr);
        // 线的名字和代码映射
        const meta = data.lineMeta || [
            {name: '沪深300', code: '000300.XSHG'},
            {name: '科创50', code: '000688.XSHG'},
            {name: 'Deepseek', code: 'Deepseek'}
        ];
        
        // 计算点评半径
        const radii1 = getCommentRadii(data.price1);
        const radii2 = getCommentRadii(data.price2);
        const radii3 = getCommentRadii(data.price3);

        // 查找基准日期在labels中的索引
        const baseDate = getCurrentBaseDate();
        let baseIdx = -1;
        
        // ** 【关键检查点】 **
        // 确保 baseDate 有值，且能在 labels 中找到对应日期
        if (baseDate && data.labels && data.labels.length) {
            // 查找标签中日期部分与输入日期匹配的第一个索引
            baseIdx = data.labels.findIndex(lab => String(lab).slice(0,10) === baseDate);
        }

        // ==========================================================
        // ** 修复逻辑：构造完整的 datasets 数组 **
        // ==========================================================
        let datasets = [
            {
                label: meta[0].name,
                data: data.line1,
                borderColor: 'rgba(54,162,235,1)',
                backgroundColor: 'rgba(54,162,235,0.1)',
                fill: false,
                pointRadius: radii1,
                pointHoverRadius: radii1.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii1.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii1.map(r => r > 0 ? 'white' : 'rgba(54,162,235,1)'),
                pointHoverBackgroundColor: radii1.map(r => r > 0 ? 'rgba(54,162,235,1)' : 'rgba(54,162,235,1)'),
                customPrices: data.price1,
                code: meta[0].code
            },
            {
                label: meta[1].name,
                data: data.line2,
                borderColor: 'rgba(75,192,192,1)',
                backgroundColor: 'rgba(75,192,192,0.1)',
                fill: false,
                pointRadius: radii2,
                pointHoverRadius: radii2.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii2.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii2.map(r => r > 0 ? 'white' : 'rgba(75,192,192,1)'),
                pointHoverBackgroundColor: radii2.map(r => r > 0 ? 'rgba(75,192,192,1)' : 'rgba(75,192,192,1)'),
                customPrices: data.price2,
                code: meta[1].code
            },
            {
                label: meta[2].name,
                data: data.line3,
                borderColor: 'rgba(255,99,132,1)',
                backgroundColor: 'rgba(255,99,132,0.1)',
                fill: false,
                pointRadius: radii3,
                pointHoverRadius: radii3.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointStyle: radii3.map(r => r > 0 ? 'circle' : 'circle'),
                pointBackgroundColor: radii3.map(r => r > 0 ? 'white' : 'rgba(255,99,132,1)'),
                pointHoverBackgroundColor: radii3.map(r => r > 0 ? 'rgba(255,99,132,1)' : 'rgba(255,99,132,1)'),
                pointBorderColor: 'rgba(255,99,132,1)',
                pointBorderWidth: 2,
                customPrices: data.price3,
                code: meta[2].code
            }
        ];

        // 动态添加自定义股票数据
        if (data.customLines && Array.isArray(data.customLines) && data.customPrices && Array.isArray(data.customPrices)) {
            const colors = [
                'rgba(255,159,64,1)',  // 橙色
                'rgba(153,102,255,1)', // 紫色
                'rgba(255,205,86,1)',  // 黄色
                'rgba(201,203,207,1)', // 灰色
                'rgba(0,128,128,1)'    // 青色
            ];
            
            const customDatasets = data.customLines.map((line, index) => {
                const customPrices = data.customPrices[index];
                // 使用 customStocks 变量获取代码名称
                const customCode = customStocks[index] || `自定义${index + 1}`; 
                const customMeta = meta[3 + index] || { name: customCode, code: customCode };
                
                const radii = getCommentRadii(customPrices);
                const colorIndex = index % colors.length; 
                const borderColor = colors[colorIndex];
                const backgroundColor = borderColor.replace('1)', '0.1)'); // 用于背景填充

                return {
                    label: customMeta.name,
                    data: line,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    fill: false,
                    pointRadius: radii,
                    pointHoverRadius: radii.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                    pointStyle: radii.map(r => r > 0 ? 'circle' : 'circle'),
                    pointBackgroundColor: radii.map(r => r > 0 ? 'white' : borderColor),
                    pointHoverBackgroundColor: radii.map(r => r > 0 ? borderColor : borderColor),
                    customPrices: customPrices,
                    code: customMeta.code
                };
            });
            datasets = datasets.concat(customDatasets); // 拼接数组
        }

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                // ** 使用完整的 datasets 变量 **
                datasets: datasets 
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'nearest',
                    intersect: true
                },
                hover: {
                    mode: 'nearest',
                    intersect: true,
                    animationDuration: 0
                },
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 16 } } },
                    tooltip: {
                        mode: 'nearest',
                        intersect: true,
                        callbacks: {
                            label: function(context) {
                                const ds = context.dataset;
                                const idx = context.dataIndex;
                                const label = ds.label || '';
                                const val = context.parsed.y;
                                const price = ds.customPrices ? ds.customPrices[idx] : undefined;
                                const radii = ds.pointRadius || [];
                                // 只在有点评节点时显示tooltip
                                if (Array.isArray(radii) && radii[idx] === 0) return '';
                                
                                // Deepseek（市值线）详细tooltip
                                if (label === 'Deepseek' && price && typeof price === 'object') {
                                    const lines = [];
                                    lines.push(`Deepseek (归一化): ${val.toFixed(2)}`);
                                    lines.push(`总价值 (RMB): ${price.total ? price.total.toFixed(2) : 'N/A'}`);
                                    lines.push(`现金 (RMB): ${price.cash ? price.cash.toFixed(2) : 'N/A'}`);
                                    const stocks = price.stocks || {};
                                    for (const code in stocks) {
                                        if (stocks.hasOwnProperty(code)) {
                                            const stock = stocks[code];
                                            lines.push(
                                                `  ${code}: 股数 ${stock.shares}, 价格 ${stock.price ? stock.price.toFixed(2) : 'N/A'}, 市值 ${stock.value ? stock.value.toFixed(2) : 'N/A'}`
                                            );
                                        }
                                    }
                                    if (typeof price.comment === 'string' && price.comment.trim() !== '') {
                                        lines.push('备注: ' + price.comment);
                                    }
                                    return lines;
                                }
                                
                                // 其他线：如有点评，优先展示点评，否则展示数值
                                if (price && typeof price === 'object' && price.comment && price.comment.trim() !== '') {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    return [`${label}: ${val.toFixed(2)} (原始价格: ${originalPrice.toFixed(2)})`, '点评: ' + price.comment];
                                } else if (price !== undefined) {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    return `${label}: ${val.toFixed(2)} (原始价格: ${originalPrice.toFixed(2)})`;
                                } else {
                                    return `${label}: ${val.toFixed(2)}`;
                                }
                            },
                            title: function(context) {
                                if (context && context.length > 0) {
                                    const ds = context[0].dataset;
                                    const idx = context[0].dataIndex;
                                    const radii = ds.pointRadius || [];
                                    if (Array.isArray(radii) && radii[idx] === 0) return '';
                                }
                                return context[0].label;
                            }
                        }
                    },
                    annotation: {
                        // ** 【修复 2：逻辑检查】 **
                        // 只有当 baseIdx >= 0 (即找到匹配日期) 时，才会生成 annotations 对象
                        annotations: baseIdx >= 0 ? {
                                baseLine: {
                                    type: 'line',
                                    xMin: baseIdx,
                                    xMax: baseIdx,
                                    borderColor: 'rgba(255, 140, 0, 0.3)',
                                    borderWidth: 4,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '基准',
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 140, 0, 0.85)',
                                        color: 'white',
                                        font: { weight: 'bold' }
                                    }
                                }
                        } : {} // 如果未找到，返回空对象，不绘制
                    }
                },
                scales: { x: { display: true }, y: { display: true } }
            }
        });

        // 保存实例，便于下次销毁
        window._chartInstance = chart;
    }
    
    // ===== 自定义股票管理 =====
    let customStocks = [];
    function renderCustomStockList() {
        const listDiv = document.getElementById('customStockList');
        listDiv.innerHTML = '';
        customStocks.forEach((code, idx) => {
            const span = document.createElement('span');
            span.textContent = code;
            span.style.cssText = 'display:inline-block;background:#f2f2f2;border-radius:3px;padding:1px 6px;margin:0 4px 2px 0;';
            const delBtn = document.createElement('button');
            delBtn.textContent = '×';
            delBtn.title = '删除';
            delBtn.style.cssText = 'margin-left:2px;font-size:12px;color:#c00;background:none;border:none;cursor:pointer;';
            delBtn.onclick = function() {
            customStocks.splice(idx,1);
            renderCustomStockList();
            triggerChartUpdate();
            if (window.saveCustomCodes) window.saveCustomCodes();
        };
            span.appendChild(delBtn);
            listDiv.appendChild(span);
        });
    }
    document.getElementById('addCustomStockBtn').onclick = function() {
        const input = document.getElementById('customStockInput');
        let code = input.value.trim();
        if (!code) return;
        if (customStocks.length >= 5) { alert('最多添加5个自定义股票'); return; }
        // 自动补全后缀
        let codeNorm = code;
        if (!/\.X[SA]HG$|\.KH$|\.XSHE$/i.test(code)) {
            // 只输入数字时自动尝试主板、科创板
            if (/^\d{6}$/.test(code)) {
                const trySuffix = ['.XSHG', '.XSHE', '.XHSG', '.KH'];
                for (let suf of trySuffix) {
                    if (!customStocks.includes(code + suf)) {
                        codeNorm = code + suf;
                        break;
                    }
                }
            }
        }
        if (customStocks.includes(codeNorm)) { alert('已存在'); return; }
        customStocks.push(codeNorm);
        input.value = '';
        renderCustomStockList();
        triggerChartUpdate();
        // 🚨 修复：添加成功后也需要保存到后端
        if (window.saveCustomCodes) window.saveCustomCodes(); 
    };
    function triggerChartUpdate() {
        const val = document.getElementById('baseDateInput').value;
        fetchData(val, customStocks).then(renderChart);
    }
    // ===== 基准日期选择控件事件绑定 =====
    document.getElementById('baseDateBtn').onclick = function() {
        triggerChartUpdate();
    };

    // 页面加载时自动用默认基准日期渲染
    const defaultBaseDate = document.getElementById('baseDateInput').value;
    fetchData(defaultBaseDate, customStocks).then(renderChart);
</script>
</body>
</html>