<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>股票对比展示</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body, input, button, select, label {
            font-family: 'Lato', Arial, sans-serif;
        }
        body { margin: 40px; }
        #chart-container { width: 90vw; max-width: 1200px; margin: auto; }
    </style>
</head>
<body>
    <div id="baseDateDiv" style="position:absolute;top:24px;right:5vw;z-index:10;background:rgba(255,255,255,0.85);padding:4px 10px 10px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-family:'Lato',Arial,sans-serif;font-size:12px;min-width:220px;">
        <label style="font-family:'Lato',Arial,sans-serif;font-size:12px;">开赛日期: <input type="date" id="baseDateInput" value="2025-10-24" style="font-family:'Lato',Arial,sans-serif;font-size:12px;"> </label>
        <button id="baseDateBtn" style="font-family:'Lato',Arial,sans-serif;font-size:12px;">应用</button>
        <div id="customStockArea" style="margin-top:8px;">
            <div style="margin-bottom:2px;font-weight:bold;">自定义股票(最多5个):</div>
            <div id="customStockList"></div>
            <div style="margin-top:4px;">
                <input id="customStockInput" type="text" maxlength="12" placeholder="股票代码" style="width:80px;font-size:12px;">
                <button id="addCustomStockBtn" style="font-size:12px;">添加</button>
            </div>
        </div>
    </div>
    <div id="chart-container">
        <canvas id="lineChart"></canvas>
    </div>
    <script src="/static/custom_code_loader.js"></script>
    <script src="/static/custom_code_save.js"></script>
    <script>
    // 定义增大后的点半径
    const VISIBLE_POINT_RADIUS = 6;
    const HOVER_POINT_RADIUS = 12;
    
    // 将 customStocks 定义为全局/顶层变量
    let customStocks = []; 

    // 注册 annotation 插件
    if (window.Chart && window.ChartAnnotation) {
        Chart.register(window.ChartAnnotation);
    }

    /**
     * 通用的 borderDash 函数，用于根据全局基准索引 (window._chartBaseIdx) 绘制虚线。
     * baseIdx 现在代表【线段开始变为实线】的那个点的索引。
     */
    function getDynamicBorderDash(ctx) {
        // ctx.p0DataIndex 是当前段起点索引，ctx.p1DataIndex 是终点索引
        const baseIdx = window._chartBaseIdx; // 这个值现在是 lineStartIdx
        if (typeof baseIdx !== 'number' || baseIdx < 0) return [];
        
        // 逻辑：如果线段的终点索引严格小于 baseIdx，则使用虚线 [6, 6]
        if (ctx.p1DataIndex < baseIdx) {
            return [6, 6]; 
        }
        return []; // 实线
    }
    
    // 将动态虚线逻辑封装到一个可重用的 segment 对象中
    const DYNAMIC_DASH_SEGMENT = {
        borderDash: getDynamicBorderDash
    };


    async function fetchData(baseDateStr, codes) {
        // 支持传递基准日期参数和自定义股票
        let url = '/api/lines';
        let params = [];
        if (baseDateStr) params.push('base_date=' + encodeURIComponent(baseDateStr));
        // 使用传递进来的 codes 数组
        if (codes && codes.length) params.push('codes=' + encodeURIComponent(codes.join(',')));
        if (params.length) url += '?' + params.join('&');
        
        const resp = await fetch(url);
        return await resp.json();
    }

    /**
     * 根据 priceX 数据计算每个点的半径。
     */
    function getCommentRadii(prices) {
        if (!prices || prices.length === 0) return [];
        // 确保 comment 不为空或纯空格
        return prices.map((p) => (p && typeof p === 'object' && p.comment && p.comment.trim() !== '') ? VISIBLE_POINT_RADIUS : 0);
    }


    // 使用 Lato 作为 Chart.js 的全局默认字体
    if (window.Chart && Chart.defaults) {
        Chart.defaults.font.family = 'Lato, Arial, sans-serif';
    }

    function formatLabelTimestr(s) {
        // 输入类似 '2025-09-26 10:30:00'，输出 'Sep 26 10:30' 形式
        const d = new Date(s);
        if (isNaN(d.getTime())) return s;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const mon = months[d.getMonth()];
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${mon} ${dd} ${hh}:${min}`;
    }

    let chartInstance = window._chartInstance;
    
    function getCurrentBaseDate() {
        const input = document.getElementById('baseDateInput');
        return input && input.value ? input.value : '';
    }

    function renderChart(data) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if (window._chartInstance) {
            window._chartInstance.destroy();
        }
        
        const formattedLabels = (data.labels || []).map(formatLabelTimestr);
        const meta = data.lineMeta || [
            {name: '沪深300', code: '000300.XSHG'},
            {name: '科创50', code: '000688.XSHG'},
            {name: 'Deepseek', code: 'Deepseek'}
        ];
        
        // 计算点评半径
        const radii1 = getCommentRadii(data.price1);
        const radii2 = getCommentRadii(data.price2);
        const radii3 = getCommentRadii(data.price3);

        // ==========================================================
        // ** 核心修正：分离线条索引和垂直基准线索引 **
        // ==========================================================
        const baseDate = getCurrentBaseDate(); 
        
        // 垂直基准线的索引：用于 Annotation
        let baseLineIdx = -1;
        // 虚实线切换的索引：用于 segment.borderDash 逻辑
        let lineStartIdx = -1; 

        if (baseDate && data.labels && data.labels.length) {
            // 查找第一个日期部分与 baseDate 匹配的索引
            const firstMatchIndex = data.labels.findIndex(lab => String(lab).slice(0,10) === baseDate);
            
            if (firstMatchIndex !== -1) {
                // 1. 垂直基准线：画在找到的第一个点（例如 9:30 的刻度）
                baseLineIdx = firstMatchIndex;
                
                // 2. 线条虚实切换：必须在找到的点【之后】开始实线，所以索引要 +1
                // 这样，线段 (Index 0 -> Index 1) 的 p1DataIndex (1) 就不满足 < lineStartIdx (1) 了。
                lineStartIdx = firstMatchIndex + 1;

                // 特殊处理：如果 firstMatchIndex 是最后一个点，+1 可能越界，但 Chart.js 会处理。
                // 另外，如果 firstMatchIndex 是 0，lineStartIdx 就是 1。如果 baseDate 之前的点都存在，这是正确的。
            }
        }
        
        // ** 将用于线条逻辑的索引赋给全局变量 **
        window._chartBaseIdx = lineStartIdx;
        
        // ==========================================================
        // ** 构造 datasets 数组 (保持不变) **
        // ==========================================================
        let datasets = [
            // 沪深300
            {
                label: meta[0].name,
                data: data.line1,
                borderColor: 'rgba(54,162,235,1)',
                backgroundColor: 'rgba(54,162,235,0.1)',
                fill: false,
                pointRadius: radii1,
                pointHoverRadius: radii1.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointBackgroundColor: radii1.map(r => r > 0 ? 'white' : 'rgba(54,162,235,1)'),
                pointHoverBackgroundColor: radii1.map(r => r > 0 ? 'rgba(54,162,235,1)' : 'rgba(54,162,235,1)'),
                pointBorderColor: 'rgba(54,162,235,1)',
                pointBorderWidth: 2,
                customPrices: data.price1,
                code: meta[0].code,
                segment: DYNAMIC_DASH_SEGMENT
            },
            // 科创50
            {
                label: meta[1].name,
                data: data.line2,
                borderColor: 'rgba(75,192,192,1)',
                backgroundColor: 'rgba(75,192,192,0.1)',
                fill: false,
                pointRadius: radii2,
                pointHoverRadius: radii2.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointBackgroundColor: radii2.map(r => r > 0 ? 'white' : 'rgba(75,192,192,1)'),
                pointHoverBackgroundColor: radii2.map(r => r > 0 ? 'rgba(75,192,192,1)' : 'rgba(75,192,192,1)'),
                pointBorderColor: 'rgba(75,192,192,1)',
                pointBorderWidth: 2,
                customPrices: data.price2,
                code: meta[1].code,
                segment: DYNAMIC_DASH_SEGMENT
            },
            // Deepseek
            {
                label: meta[2].name,
                data: data.line3,
                borderColor: 'rgba(255,99,132,1)',
                backgroundColor: 'rgba(255,99,132,0.1)',
                fill: false,
                pointRadius: radii3,
                pointHoverRadius: radii3.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                pointBackgroundColor: radii3.map(r => r > 0 ? 'white' : 'rgba(255,99,132,1)'),
                pointHoverBackgroundColor: radii3.map(r => r > 0 ? 'rgba(255,99,132,1)' : 'rgba(255,99,132,1)'),
                pointBorderColor: 'rgba(255,99,132,1)',
                pointBorderWidth: 2,
                customPrices: data.price3,
                code: meta[2].code,
                segment: DYNAMIC_DASH_SEGMENT
            }
        ];

        // 动态添加自定义股票数据 (保持不变)
        if (data.customLines && Array.isArray(data.customLines) && data.customPrices && Array.isArray(data.customPrices)) {
            const colors = [
                'rgba(255,159,64,1)',  // 橙色
                'rgba(153,102,255,1)', // 紫色
                'rgba(255,205,86,1)',  // 黄色
                'rgba(201,203,207,1)', // 灰色
                'rgba(0,128,128,1)'    // 青色
            ];
            
            const customDatasets = data.customLines.map((line, index) => {
                const customPrices = data.customPrices[index];
                const customCode = customStocks[index] || `自定义${index + 1}`; 
                const customMeta = meta[3 + index] || { name: customCode, code: customCode };
                
                const radii = getCommentRadii(customPrices);
                const colorIndex = index % colors.length; 
                const borderColor = colors[colorIndex];
                const backgroundColor = borderColor.replace('1)', '0.1)'); 

                return {
                    label: customMeta.name,
                    data: line,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    fill: false,
                    pointRadius: radii,
                    pointHoverRadius: radii.map(r => r > 0 ? HOVER_POINT_RADIUS : 0),
                    pointBackgroundColor: radii.map(r => r > 0 ? 'white' : borderColor),
                    pointHoverBackgroundColor: radii.map(r => r > 0 ? borderColor : borderColor),
                    pointBorderColor: borderColor,
                    pointBorderWidth: 2,
                    customPrices: customPrices,
                    code: customMeta.code,
                    segment: DYNAMIC_DASH_SEGMENT
                };
            });
            datasets = datasets.concat(customDatasets);
        }

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: datasets 
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'nearest',
                    intersect: true
                },
                hover: {
                    mode: 'nearest',
                    intersect: true,
                    animationDuration: 0
                },
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 16 } } },
                    tooltip: {
                        mode: 'nearest',
                        intersect: true,
                        callbacks: {
                            label: function(context) {
                                const ds = context.dataset;
                                const idx = context.dataIndex;
                                const label = ds.label || '';
                                const val = context.parsed.y;
                                const price = ds.customPrices ? ds.customPrices[idx] : undefined;
                                const radii = ds.pointRadius || [];
                                // 只在有点评节点时显示tooltip
                                if (Array.isArray(radii) && radii[idx] === 0) return '';
                                
                                // Deepseek（市值线）详细tooltip
                                if (label === 'Deepseek' && price && typeof price === 'object') {
                                    const lines = [];
                                    lines.push(`Deepseek (归一化): ${val.toFixed(2)}`);
                                    lines.push(`总价值 (RMB): ${price.total ? price.total.toFixed(2) : 'N/A'}`);
                                    lines.push(`现金 (RMB): ${price.cash ? price.cash.toFixed(2) : 'N/A'}`);
                                    const stocks = price.stocks || {};
                                    for (const code in stocks) {
                                        if (stocks.hasOwnProperty(code)) {
                                            const stock = stocks[code];
                                            lines.push(
                                                `  ${code}: 股数 ${stock.shares}, 价格 ${stock.price ? stock.price.toFixed(2) : 'N/A'}, 市值 ${stock.value ? stock.value.toFixed(2) : 'N/A'}`
                                            );
                                        }
                                    }
                                    if (typeof price.comment === 'string' && price.comment.trim() !== '') {
                                        lines.push('备注: ' + price.comment);
                                    }
                                    return lines;
                                }
                                
                                // 其他线：如有点评，优先展示点评，否则展示数值
                                if (price && typeof price === 'object' && price.comment && price.comment.trim() !== '') {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    return [`${label}: ${val.toFixed(2)} (原始价格: ${originalPrice.toFixed(2)})`, '点评: ' + price.comment];
                                } else if (price !== undefined) {
                                    const originalPrice = typeof price === 'object' ? price.value || price.total : price;
                                    // 检查 price 数组中是否存在 comment，以便统一处理非 Deepseek 线
                                    if (typeof price === 'object' && price.comment && price.comment.trim() !== '') {
                                        return [`${label}: ${val.toFixed(2)} (原始价格: ${originalPrice.toFixed(2)})`, '点评: ' + price.comment];
                                    }
                                    return `${label}: ${val.toFixed(2)} (原始价格: ${originalPrice.toFixed(2)})`;
                                } else {
                                    return `${label}: ${val.toFixed(2)}`;
                                }
                            },
                            title: function(context) {
                                if (context && context.length > 0) {
                                    const ds = context[0].dataset;
                                    const idx = context[0].dataIndex;
                                    const radii = ds.pointRadius || [];
                                    if (Array.isArray(radii) && radii[idx] === 0) return '';
                                }
                                return context[0].label;
                            }
                        }
                    },
                    annotation: {
                        // ** 核心修正：使用 baseLineIdx 控制垂直线位置 **
                        annotations: baseLineIdx >= 0 ? {
                                baseLine: {
                                    type: 'line',
                                    xMin: baseLineIdx, // 使用正确的垂直线索引
                                    xMax: baseLineIdx, // 使用正确的垂直线索引
                                    borderColor: 'rgba(255, 140, 0, 0.3)',
                                    borderWidth: 4,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '基准',
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 140, 0, 0.85)',
                                        color: 'white',
                                        font: { weight: 'bold' }
                                    }
                                }
                        } : {} 
                    }
                },
                scales: { x: { display: true }, y: { beginAtZero: false } } 
            }
        });

        window._chartInstance = chart;
    }
    
    // ===== 自定义股票管理 (保持不变) =====
    function renderCustomStockList() {
        const listDiv = document.getElementById('customStockList');
        listDiv.innerHTML = '';
        customStocks.forEach((code, idx) => {
            const span = document.createElement('span');
            span.textContent = code;
            span.style.cssText = 'display:inline-block;background:#f2f2f2;border-radius:3px;padding:1px 6px;margin:0 4px 2px 0;';
            const delBtn = document.createElement('button');
            delBtn.textContent = '×';
            delBtn.title = '删除';
            delBtn.style.cssText = 'margin-left:2px;font-size:12px;color:#c00;background:none;border:none;cursor:pointer;';
            delBtn.onclick = function() {
                customStocks.splice(idx,1);
                renderCustomStockList();
                triggerChartUpdate();
                if (window.saveCustomCodes) window.saveCustomCodes(customStocks); 
            };
            span.appendChild(delBtn);
            listDiv.appendChild(span);
        });
    }
    document.getElementById('addCustomStockBtn').onclick = function() {
        const input = document.getElementById('customStockInput');
        let code = input.value.trim();
        if (!code) return;
        if (customStocks.length >= 5) { alert('最多添加5个自定义股票'); return; }
        
        let codeNorm = code;
        if (!/\.X[SA]HG$|\.KH$|\.XSHE$/i.test(code)) {
            if (/^\d{6}$/.test(code)) {
                if (code.startsWith('60')) codeNorm = code + '.XSHG';
                else if (code.startsWith('00') || code.startsWith('30')) codeNorm = code + '.XSHE';
            }
        }
        
        if (customStocks.includes(codeNorm)) { alert('已存在'); return; }
        customStocks.push(codeNorm);
        input.value = '';
        renderCustomStockList();
        triggerChartUpdate();
        if (window.saveCustomCodes) window.saveCustomCodes(customStocks); 
    };
    function triggerChartUpdate() {
        const val = document.getElementById('baseDateInput').value;
        // 传递 customStocks 变量
        fetchData(val, customStocks).then(renderChart);
    }
    // ===== 基准日期选择控件事件绑定 (保持不变) =====
    document.getElementById('baseDateBtn').onclick = function() {
        triggerChartUpdate();
    };

    // ** 【初始化逻辑】 (保持不变) **
    function initializeChart() {
        if (window.loadCustomCodes) {
            customStocks = window.loadCustomCodes() || [];
        }
        renderCustomStockList();
        
        const defaultBaseDate = document.getElementById('baseDateInput').value;
        fetchData(defaultBaseDate, customStocks).then(renderChart);
    }

    initializeChart();
</script>
</body>
</html>